<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="x.y.z.backend.repository.mapper.RefreshTokenMapper">

    <!-- Result Map for RefreshToken -->
    <resultMap id="RefreshTokenResultMap" type="x.y.z.backend.domain.model.RefreshToken">
        <id property="id" column="id" javaType="java.lang.Long"/>
        <result property="userId" column="user_id" javaType="java.lang.Long"/>
        <result property="tokenHash" column="token_hash"/>
        <result property="issuedAt" column="issued_at"/>
        <result property="expiresAt" column="expires_at"/>
        <result property="lastUsedAt" column="last_used_at"/>
        <result property="ipAddress" column="ip_address"/>
        <result property="userAgent" column="user_agent"/>
        <result property="isRevoked" column="is_revoked"/>
        <result property="revokedAt" column="revoked_at"/>
        <result property="revokedReason" column="revoked_reason"/>
    </resultMap>

    <!-- Insert RefreshToken -->
    <insert id="insert" parameterType="x.y.z.backend.domain.model.RefreshToken" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO RAP.refresh_tokens (
            user_id,
            token_hash,
            expires_at,
            is_revoked,
            ip_address,
            user_agent,
            revoked_at
        ) VALUES (
            #{userId, jdbcType=BIGINT},
            #{tokenHash, jdbcType=VARCHAR},
            #{expiresAt, jdbcType=TIMESTAMP},
            #{isRevoked, jdbcType=BIT},
            #{ipAddress, jdbcType=VARCHAR},
            #{userAgent, jdbcType=VARCHAR},
            #{revokedAt, jdbcType=TIMESTAMP}
        )
    </insert>

    <!-- Find RefreshToken by ID -->
    <select id="findById" resultMap="RefreshTokenResultMap">
        SELECT * FROM RAP.refresh_tokens
        WHERE id = #{id}
    </select>

    <!-- Find RefreshToken by Token Hash -->
    <select id="findByTokenHash" resultMap="RefreshTokenResultMap">
        SELECT * FROM RAP.refresh_tokens
        WHERE token_hash = #{tokenHash}
    </select>

    <!-- Find Active RefreshTokens by User ID -->
    <select id="findActiveByUserId" resultMap="RefreshTokenResultMap">
        SELECT * FROM RAP.refresh_tokens
        WHERE user_id = #{userId}
          AND is_revoked = 0
          AND expires_at > GETUTCDATE()
        ORDER BY issued_at DESC
    </select>

    <!-- Find All RefreshTokens by User ID -->
    <select id="findByUserId" resultMap="RefreshTokenResultMap">
        SELECT * FROM RAP.refresh_tokens
        WHERE user_id = #{userId}
        ORDER BY issued_at DESC
    </select>

    <!-- Revoke RefreshToken -->
    <update id="revoke">
        UPDATE RAP.refresh_tokens
        SET is_revoked = 1,
            revoked_at = #{revokedAt}
        WHERE id = #{id}
    </update>

    <!-- Revoke All RefreshTokens for User -->
    <update id="revokeAllByUserId">
        UPDATE RAP.refresh_tokens
        SET is_revoked = 1,
            revoked_at = #{revokedAt}
        WHERE user_id = #{userId}
          AND is_revoked = 0
    </update>

    <!-- Delete Expired RefreshTokens -->
    <delete id="deleteExpired">
        DELETE FROM RAP.refresh_tokens
        WHERE expires_at &lt; #{currentTime}
    </delete>

    <!-- Delete RefreshToken by ID -->
    <delete id="deleteById">
        DELETE FROM RAP.refresh_tokens
        WHERE id = #{id}
    </delete>

</mapper>
