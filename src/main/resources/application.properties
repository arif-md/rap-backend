spring.application.name=backend

# ===========================================================================
# Azure SQL Database Configuration with Managed Identity (Passwordless)
# ===========================================================================
# Connection string format varies based on deployment mode:
#
# PUBLIC ACCESS MODE (current):
#   - Endpoint: <server>.database.windows.net (public DNS)
#   - Authentication: Managed Identity (recommended) or SQL authentication
#   - Firewall: "Allow Azure Services" rule enabled
#   - Format: jdbc:sqlserver://<server>.database.windows.net:1433;databaseName=<db>;authentication=ActiveDirectoryMSI;
#
# PRIVATE ENDPOINT MODE (future - requires ENABLE_VNET_INTEGRATION=true):
#   - Endpoint: <server>.privatelink.database.windows.net (private DNS)
#   - Authentication: Managed Identity (recommended) or SQL authentication
#   - Network: Private IP within VNet (10.0.2.x)
#   - Format: jdbc:sqlserver://<server>.database.windows.net:1433;databaseName=<db>;authentication=ActiveDirectoryMSI;
#   - Note: Same JDBC URL works for both modes - DNS resolution changes based on VNet config
#
# MANAGED IDENTITY AUTHENTICATION (Azure - recommended):
spring.datasource.url=${AZURE_SQL_CONNECTIONSTRING:jdbc:sqlserver://localhost:1433;databaseName=rapdb;encrypt=true;trustServerCertificate=true;}
# No username/password needed when using Managed Identity in Azure
# The spring-cloud-azure-starter-jdbc-mssql library handles token acquisition automatically

# SQL AUTHENTICATION (fallback - local development only):
# Uncomment for local Docker testing with SQL Server container
#spring.datasource.username=${AZURE_SQL_USERNAME:sa}
#spring.datasource.password=${AZURE_SQL_PASSWORD:YourStrong@Passw0rd}

spring.datasource.driver-class-name=com.microsoft.sqlserver.jdbc.SQLServerDriver

# Connection Pool Settings (HikariCP - default in Spring Boot)
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000

# ===========================================================================
# MyBatis Configuration
# ===========================================================================
# Mapper XML files location
mybatis.mapper-locations=classpath:mapper/**/*.xml
# Type aliases package (allows using simple class names in mappers)
mybatis.type-aliases-package=x.y.z.backend.domain.model
# Enable camelCase mapping (database_column -> databaseColumn)
mybatis.configuration.map-underscore-to-camel-case=true
# Show SQL in logs (disable in production)
mybatis.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl

# ===========================================================================
# Flyway Database Migration Configuration
# ===========================================================================
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true
spring.flyway.validate-on-migrate=true
# Clean schema on startup - DANGEROUS! Only for development
# spring.flyway.clean-disabled=false

# ===========================================================================
# Spring Boot Actuator Configuration
# ===========================================================================
management.endpoints.web.exposure.include=health,info,flyway
management.endpoint.health.show-details=when-authorized
management.health.db.enabled=true

# ===========================================================================
# Transaction Management (without JPA/Hibernate)
# ===========================================================================
# Spring JDBC transaction manager is auto-configured when using MyBatis
# No additional configuration needed for basic transactions

# ===========================================================================
# Logging Configuration
# ===========================================================================
logging.file.name=/tmp/application.log
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss} - %msg%n
logging.level.x.y.z.backend=DEBUG
logging.level.org.mybatis=DEBUG
logging.level.com.microsoft.sqlserver.jdbc=INFO
logging.level.org.springframework.jdbc=DEBUG
logging.level.org.springframework.transaction=DEBUG

# ===========================================================================
# NOTES FOR AZURE DEPLOYMENT
# ===========================================================================
# When deploying to Azure Container Apps with Managed Identity:
# 
# 1. The following environment variables will be automatically set by Azure:
#    AZURE_SQL_CONNECTIONSTRING=jdbc:sqlserver://<server>.database.windows.net:1433;databaseName=<db>;authentication=ActiveDirectoryMSI;
#    
# 2. Remove or comment out AZURE_SQL_USERNAME and AZURE_SQL_PASSWORD in Azure
#    
# 3. Ensure the Container App's Managed Identity has been granted database access:
#    CREATE USER [<managed-identity-name>] FROM EXTERNAL PROVIDER;
#    ALTER ROLE db_datareader ADD MEMBER [<managed-identity-name>];
#    ALTER ROLE db_datawriter ADD MEMBER [<managed-identity-name>];
#    ALTER ROLE db_ddladmin ADD MEMBER [<managed-identity-name>];
#    
# 4. For local development, use Docker Compose with SQL Server container
#    and SQL authentication (current default values above)

